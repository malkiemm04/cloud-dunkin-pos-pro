<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Dunkin' POS Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Base styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: linear-gradient(135deg, #ff6b00 0%, #d90000 100%); min-height: 100vh; padding: 20px; }
        
        /* Cloud Badge */
        .cloud-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff9900;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        /* Login Container */
        .login-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .login-container.active {
            display: flex;
        }
        
        .login-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .login-content h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }
        
        /* Main container */
        .pos-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            min-height: 90vh;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: #2c3e50;
            padding: 0;
            border-bottom: 3px solid #ff8c00;
        }
        .nav-tab {
            padding: 18px 30px;
            color: #ecf0f1;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            border-right: 1px solid #34495e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-tab.active {
            background: #ff8c00;
            color: white;
        }
        .nav-tab:hover:not(.active) {
            background: #34495e;
        }

        /* Content Areas */
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 700px;
        }
        .tab-content.active {
            display: block;
        }

        /* POS Tab - Redesigned */
        #pos-tab {
            padding: 0;
        }
        .pos-main {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            height: 100%;
        }

        /* Menu Section */
        .menu-section {
            padding: 30px;
            background: #f8f9fa;
            border-right: 2px dashed #e0e0e0;
        }

        .menu-section h2 {
            color: #d22c26;
            margin-bottom: 10px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-section h2 i {
            color: #ff8c00;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .category-tab.active {
            background: #ff8c00;
            color: white;
            border-color: #ff8c00;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .menu-item {
            background: white;
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            border-color: #ff8c00;
            box-shadow: 0 10px 20px rgba(255, 140, 0, 0.15);
        }

        .item-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: #d22c26;
        }

        .item-name {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 5px;
            color: #333;
        }

        .item-price {
            color: #ff8c00;
            font-weight: 800;
            font-size: 20px;
            margin-top: auto;
        }

        /* Order Section */
        .order-section {
            padding: 30px;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .order-section h2 {
            color: #d22c26;
            margin-bottom: 20px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-section h2 i {
            color: #ff8c00;
        }

        .order-items {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 25px;
            max-height: 400px;
            border-bottom: 2px dashed #e0e0e0;
            padding-bottom: 20px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .item-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ff8c00;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-qty {
            font-weight: 700;
            min-width: 30px;
            text-align: center;
        }

        .remove-item {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .totals {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .grand-total {
            font-size: 26px;
            font-weight: 900;
            color: #d22c26;
            border-top: 2px solid #ddd;
            padding-top: 15px;
            margin-top: 15px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .checkout-btn {
            background: linear-gradient(to right, #ff8c00, #ff6b00);
            color: white;
        }

        .checkout-btn:hover {
            background: linear-gradient(to right, #e67e00, #e65c00);
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(255, 140, 0, 0.4);
        }

        .clear-btn {
            background: #f1f2f6;
            color: #333;
        }

        .clear-btn:hover {
            background: #e0e0e0;
        }

        .empty-cart {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 40px 20px;
        }

        /* Payment Modal */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .payment-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        .payment-method {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .payment-method.selected {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.05);
        }
        .payment-method i {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        /* Receipt Modal */
        .receipt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .receipt-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px dashed #333;
            padding-bottom: 15px;
        }

        .receipt-header h3 {
            color: #d22c26;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .receipt-items {
            margin-bottom: 20px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dotted #ddd;
        }

        .close-receipt {
            width: 100%;
            padding: 15px;
            background: #ff8c00;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Admin Panel */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        .admin-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid #ff8c00;
        }
        .admin-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }
        .form-control:focus {
            border-color: #ff8c00;
            outline: none;
        }

        /* Reports */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 30px;
        }
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }
        .chart-card canvas {
            max-height: 300px;
        }
        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 10px 25px;
            background: #f1f2f6;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .filter-btn.active {
            background: #ff8c00;
            color: white;
        }

        /* Inventory */
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }
        .inventory-table th {
            background: #2c3e50;
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
        }
        .inventory-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .inventory-table tr:hover {
            background: #f8f9fa;
        }
        .stock-low {
            color: #e74c3c;
            font-weight: 700;
        }
        .stock-ok {
            color: #27ae60;
            font-weight: 700;
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .pos-main {
                grid-template-columns: 1fr;
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 1024px) {
            .pos-main {
                grid-template-columns: 1fr;
            }
            
            .menu-section {
                border-right: none;
                border-bottom: 2px dashed #e0e0e0;
            }
        }
        @media (max-width: 768px) {
            .nav-tab {
                padding: 15px 20px;
                font-size: 14px;
            }
            .admin-grid {
                grid-template-columns: 1fr;
            }
            .payment-methods {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                grid-template-columns: 1fr;
            }
            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Cloud status indicator -->
    <div class="cloud-badge">
        <i class="fas fa-cloud"></i> AWS Hosted
    </div>
    
    <!-- Login Modal -->
    <div class="login-container active" id="loginModal">
        <div class="login-content">
            <h2>
                <i class="fas fa-cloud"></i> Cloud Dunkin' POS
            </h2>
            <p style="color: #666; margin-bottom: 30px;">Authentication Required</p>
            
            <div id="loginError" class="error-message"></div>
            
            <input type="text" id="username" placeholder="Email" class="form-control">
            <input type="password" id="password" placeholder="Password" class="form-control">
            
            <button class="btn checkout-btn" id="loginBtn" style="margin-top: 20px; width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
            
            <div style="margin-top: 20px; color: #888; font-size: 12px;">
                <i class="fas fa-info-circle"></i> 
                Data stored in AWS DynamoDB | Served via CloudFront
            </div>
        </div>
    </div>
    
    <!-- POS Container -->
    <div class="pos-container" id="posContainer" style="display: none;">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="pos-tab">
                <i class="fas fa-cash-register"></i> POS
            </div>
            <div class="nav-tab" data-tab="admin-tab">
                <i class="fas fa-cog"></i> Admin Panel
            </div>
            <div class="nav-tab" data-tab="reports-tab">
                <i class="fas fa-chart-bar"></i> Sales Reports
            </div>
            <div class="nav-tab" data-tab="inventory-tab">
                <i class="fas fa-boxes"></i> Inventory
            </div>
        </div>

        <!-- POS Tab -->
        <div id="pos-tab" class="tab-content active">
            <div class="pos-main">
                <!-- Menu Section -->
                <div class="menu-section">
                    <h2><i class="fas fa-store"></i> Dunkin' Menu</h2>
                    <p style="color: #666; margin-bottom: 25px;">Click items to add to order</p>
                    
                    <div class="category-tabs">
                        <div class="category-tab active" data-category="all">All Items</div>
                        <div class="category-tab" data-category="donuts">Donuts</div>
                        <div class="category-tab" data-category="coffee">Coffee</div>
                        <div class="category-tab" data-category="drinks">Drinks</div>
                    </div>
                    
                    <div class="menu-grid" id="menuGrid">
                        <div class="loading">Loading menu from cloud...</div>
                    </div>
                </div>
                
                <!-- Order Section -->
                <div class="order-section">
                    <h2><i class="fas fa-receipt"></i> Current Order</h2>
                    
                    <div class="order-items" id="orderItems">
                        <div class="empty-cart" id="emptyCart">
                            <i class="fas fa-shopping-cart" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                            <p>Your order is empty</p>
                            <p style="font-size: 14px;">Click items from the menu to get started</p>
                        </div>
                    </div>
                    
                    <div class="totals">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">RM 0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Tax (6%):</span>
                            <span id="tax">RM 0.00</span>
                        </div>
                        <div class="total-row grand-total">
                            <span>Total:</span>
                            <span id="total">RM 0.00</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn clear-btn" id="clearOrder">
                            <i class="fas fa-trash-alt"></i> Clear Order
                        </button>
                        <button class="btn checkout-btn" id="checkoutBtn">
                            <i class="fas fa-credit-card"></i> Proceed to Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel Tab -->
        <div id="admin-tab" class="tab-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <div>
                    <h2 style="margin: 0;"><i class="fas fa-cog"></i> Admin Panel</h2>
                    <p style="color: #666; margin: 5px 0 0 0;">Manage menu, users, and system settings</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="adminProfileInfo" style="display: none; padding: 10px 15px; background: #e8f5e9; border-radius: 8px;">
                        <i class="fas fa-user-circle"></i> 
                        <span id="adminDisplayName" style="font-weight: 600; margin-left: 8px;"></span>
                    </div>
                    <button class="btn clear-btn" id="adminLogoutBtn" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <div class="admin-grid">
                <div class="admin-card">
                    <h3><i class="fas fa-utensils"></i> Menu Management</h3>
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="itemName" class="form-control" placeholder="e.g., Chocolate Donut">
                    </div>
                    <div class="form-group">
                        <label>Price (RM)</label>
                        <input type="number" id="itemPrice" class="form-control" placeholder="e.g., 4.50" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="itemCategory" class="form-control">
                            <option value="donuts">Donuts</option>
                            <option value="coffee">Coffee</option>
                            <option value="drinks">Drinks</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description (Optional)</label>
                        <input type="text" id="itemDescription" class="form-control" placeholder="e.g., Delicious chocolate glazed donut">
                    </div>
                    <div class="form-group">
                        <label>Item Image</label>
                        <input type="file" id="itemImage" class="form-control" accept="image/*" style="padding: 8px;">
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                            Upload image for menu item (JPG, PNG, GIF, WebP)
                        </small>
                        <div id="imagePreview" style="margin-top: 10px; display: none;">
                            <img id="previewImg" src="" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid #ddd;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Initial Stock</label>
                        <input type="number" id="itemStock" class="form-control" placeholder="e.g., 100" value="100">
                    </div>
                    <button class="btn checkout-btn" id="addMenuItem" style="width: 100%;">
                        <i class="fas fa-plus"></i> Add Menu Item
                    </button>
                </div>
                
                <div class="admin-card">
                    <h3><i class="fas fa-users"></i> User Management</h3>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="adminUsername" class="form-control" placeholder="e.g., john_doe">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="userRole" class="form-control">
                            <option value="cashier">Cashier</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button class="btn checkout-btn" id="addUser" style="width: 100%;">
                        <i class="fas fa-user-plus"></i> Add User
                    </button>
                </div>
                
                <div class="admin-card">
                    <h3><i class="fas fa-chart-line"></i> System Overview</h3>
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span>Total Sales Today:</span>
                            <strong id="todaySales">RM 0.00</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span>Transactions Today:</span>
                            <strong id="todayTransactions">0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span>Low Stock Items:</span>
                            <strong id="lowStockCount">0</strong>
                        </div>
                    </div>
                    <button class="btn clear-btn" id="resetData" style="width: 100%;">
                        <i class="fas fa-redo"></i> Reset Demo Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Sales Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <h2><i class="fas fa-chart-bar"></i> Sales Reports & Analytics</h2>
            <p style="color: #666; margin-bottom: 25px;">Real-time sales data and performance insights</p>
            
            <div class="report-filters">
                <button class="filter-btn active" data-period="today">Today</button>
                <button class="filter-btn" data-period="week">This Week</button>
                <button class="filter-btn" data-period="month">This Month</button>
                <button class="filter-btn" data-period="year">This Year</button>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3><i class="fas fa-money-bill-wave"></i> Sales Trend</h3>
                    <canvas id="salesChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3><i class="fas fa-box"></i> Top Selling Items</h3>
                    <canvas id="topItemsChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3><i class="fas fa-clock"></i> Hourly Sales</h3>
                    <canvas id="hourlyChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3><i class="fas fa-tags"></i> Category Performance</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <div style="margin-top: 40px;">
                <h3><i class="fas fa-table"></i> Recent Transactions</h3>
                <div style="overflow-x: auto;">
                    <table class="inventory-table" style="margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Time</th>
                                <th>Items</th>
                                <th>Payment Method</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory-tab" class="tab-content">
            <h2><i class="fas fa-boxes"></i> Inventory Tracking</h2>
            <p style="color: #666; margin-bottom: 25px;">Real-time stock levels with automatic updates</p>
            
            <div style="display: flex; gap: 15px; margin-bottom: 25px;">
                <button class="btn checkout-btn" id="refreshInventory">
                    <i class="fas fa-sync-alt"></i> Refresh Inventory
                </button>
                <button class="btn clear-btn" id="exportInventory">
                    <i class="fas fa-file-export"></i> Export CSV
                </button>
            </div>
            
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Low Stock Alert</th>
                        <th>Sold Today</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Filled by JavaScript -->
                </tbody>
            </table>
            
            <div style="margin-top: 40px; background: #f8f9fa; padding: 25px; border-radius: 15px;">
                <h3><i class="fas fa-bell"></i> Low Stock Alerts</h3>
                <div id="lowStockAlerts">
                    <!-- Alerts appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="payment-modal" id="paymentModal">
        <div class="payment-content">
            <h2 style="color: #2c3e50; margin-bottom: 10px;">
                <i class="fas fa-credit-card"></i> Complete Payment
            </h2>
            <p style="color: #666; margin-bottom: 25px;">Total: <strong id="paymentTotal">RM 0.00</strong></p>
            
            <div class="payment-methods">
                <div class="payment-method" data-method="cash">
                    <i class="fas fa-money-bill-wave" style="color: #27ae60;"></i>
                    <div>Cash</div>
                </div>
                <div class="payment-method" data-method="card">
                    <i class="fas fa-credit-card" style="color: #3498db;"></i>
                    <div>Credit/Debit Card</div>
                </div>
                <div class="payment-method" data-method="mobile">
                    <i class="fas fa-mobile-alt" style="color: #9b59b6;"></i>
                    <div>Mobile Pay</div>
                </div>
            </div>
            
            <div id="cardDetails" style="display: none; margin: 25px 0;">
                <div class="form-group">
                    <label>Card Number</label>
                    <input type="text" class="form-control" placeholder="4242 4242 4242 4242" value="4242424242424242">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Expiry Date</label>
                        <input type="text" class="form-control" placeholder="MM/YY" value="12/30">
                    </div>
                    <div class="form-group">
                        <label>CVV</label>
                        <input type="text" class="form-control" placeholder="123" value="123">
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn clear-btn" id="cancelPayment" style="flex: 1;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn checkout-btn" id="confirmPayment" style="flex: 2;">
                    <i class="fas fa-lock"></i> Confirm Payment
                </button>
            </div>
            
            <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 14px; color: #666;">
                <i class="fas fa-info-circle"></i> <strong>Demo Note:</strong> This is a simulation. No real payment is processed. For card payments, use test card number 4242 4242 4242 4242.
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div class="receipt-modal" id="receiptModal">
        <div class="receipt-content">
            <div class="receipt-header">
                <h3>DUNKIN' DONUTS</h3>
                <p>123 Main Street, Kuala Lumpur</p>
                <p>Transaction #: <span id="receiptNumber">DD-001</span></p>
                <p id="receiptDate">May 16, 2023 10:30 AM</p>
            </div>
            
            <div class="receipt-items" id="receiptItems">
                <!-- Receipt items populated by JavaScript -->
            </div>
            
            <div class="totals">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span id="receiptSubtotal">RM 0.00</span>
                </div>
                <div class="total-row">
                    <span>Tax (6%):</span>
                    <span id="receiptTax">RM 0.00</span>
                </div>
                <div class="total-row grand-total">
                    <span>Total:</span>
                    <span id="receiptTotal">RM 0.00</span>
                </div>
            </div>
            
            <button class="close-receipt" id="closeReceipt">
                <i class="fas fa-print"></i> Print Receipt & Close
            </button>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="payment-modal" id="adminLoginModal" style="display: none;">
        <div class="payment-content">
            <h2 style="color: #2c3e50; margin-bottom: 10px;">
                <i class="fas fa-shield-alt"></i> Admin Authentication
            </h2>
            <p style="color: #666; margin-bottom: 20px;">Please login to access the Admin Panel</p>
            
            <div id="adminLoginError" class="error-message" style="display: none; background: #fee; color: #c33; padding: 10px; border-radius: 5px; margin-bottom: 15px;"></div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Admin Username</label>
                <input type="text" id="adminLoginUsername" class="form-control" placeholder="Enter admin username" autocomplete="username">
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Password</label>
                <input type="password" id="adminLoginPassword" class="form-control" placeholder="Enter password" autocomplete="current-password">
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn clear-btn" id="cancelAdminLogin" style="flex: 1;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn checkout-btn" id="confirmAdminLogin" style="flex: 2;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                <strong>Demo Credentials:</strong><br>
                Username: <code>admin</code><br>
                Password: <code>admin123</code>
            </div>
        </div>
    </div>

    <!-- Add Inventory Item Modal -->
    <div class="payment-modal" id="addInventoryModal" style="display: none;">
        <div class="payment-content">
            <h2 style="color: #2c3e50; margin-bottom: 10px;">
                <i class="fas fa-plus-circle"></i> Add Inventory Item
            </h2>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Item ID *</label>
                <input type="text" class="form-control" id="inventoryItemId" placeholder="e.g., inv-001" required>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Item Name *</label>
                <input type="text" class="form-control" id="inventoryItemName" placeholder="e.g., Coffee Beans" required>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Category</label>
                <input type="text" class="form-control" id="inventoryItemCategory" placeholder="e.g., Supplies" value="General">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>Initial Quantity *</label>
                    <input type="number" class="form-control" id="inventoryItemQuantity" placeholder="0" value="0" min="0" required>
                </div>
                <div class="form-group">
                    <label>Low Stock Alert</label>
                    <input type="number" class="form-control" id="inventoryItemLowAlert" placeholder="10" value="10" min="0">
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn clear-btn" id="cancelAddInventory" style="flex: 1;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn checkout-btn" id="confirmAddInventory" style="flex: 2; background: #27ae60;">
                    <i class="fas fa-check"></i> Add Item
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================
        // CLOUD CONFIGURATION
        // ====================
        const CLOUD_CONFIG = {
            API_ENDPOINT: window.location.hostname.includes('localhost') 
                ? 'http://localhost:3000' 
                : 'https://xwy642cm99.execute-api.us-east-1.amazonaws.com/dev',
            REGION: 'us-east-1',
            ENABLED: true // Cloud connection enabled
        };
        
        // ====================
        // DATA MANAGEMENT (Cloud-Integrated)
        // ====================
        const POSData = {
            menuItems: [],
            inventory: {},
            transactions: [],
            users: [],
            settings: { taxRate: 0.06 },
            
            // Load data from cloud API
            async load() {
                try {
                    await this.loadMenu();
                    await this.loadOrders();
                    this.initInventory();
                } catch (error) {
                    console.error('Error loading data:', error);
                    // Fallback to default menu
                    this.menuItems = this.getDefaultMenu();
                    this.initInventory();
                }
            },
            
            async loadMenu() {
                try {
                    const response = await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/menu`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        // Ensure all items have proper structure, including imageUrl
                        const getIcon = (cat) => {
                            const icons = { donuts: 'ðŸ©', coffee: 'â˜•', drinks: 'ðŸ¥¤' };
                            return icons[cat] || 'ðŸ“¦';
                        };
                        this.menuItems = data.length > 0 ? data.map(item => ({
                            ...item,
                            imageUrl: item.imageUrl || null, // Preserve imageUrl if it exists
                            icon: item.icon || getIcon(item.category || 'donuts')
                        })) : this.getDefaultMenu();
                    } else {
                        this.menuItems = this.getDefaultMenu();
                    }
                } catch (error) {
                    console.error('Error loading menu:', error);
                    this.menuItems = this.getDefaultMenu();
                }
            },
            
            async loadOrders() {
                try {
                    const response = await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/orders`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.transactions = data || [];
                    }
                } catch (error) {
                    console.error('Error loading orders:', error);
                    // Load from localStorage as fallback
                    this.transactions = JSON.parse(localStorage.getItem('dd_transactions')) || [];
                }
            },
            
            getDefaultMenu() {
                return [
                    {id: '1', name: "Glazed Donut", price: 3.50, icon: "ðŸ©", category: "donuts", stock: 50},
                    {id: '2', name: "Chocolate Frosted", price: 4.00, icon: "ðŸ«", category: "donuts", stock: 45},
                    {id: '3', name: "Jelly Filled", price: 4.50, icon: "ðŸ«", category: "donuts", stock: 30},
                    {id: '4', name: "Boston Kreme", price: 4.00, icon: "ðŸ®", category: "donuts", stock: 25},
                    {id: '5', name: "Coffee", price: 5.00, icon: "â˜•", category: "coffee", stock: 100},
                    {id: '6', name: "Iced Coffee", price: 6.00, icon: "ðŸ§Š", category: "coffee", stock: 80},
                    {id: '7', name: "Latte", price: 7.50, icon: "ðŸ¥›", category: "coffee", stock: 60},
                    {id: '8', name: "Cappuccino", price: 7.00, icon: "â˜•", category: "coffee", stock: 70},
                    {id: '9', name: "Iced Latte", price: 7.00, icon: "ðŸ¥¤", category: "drinks", stock: 55},
                    {id: '10', name: "Cold Brew", price: 6.50, icon: "ðŸ§Š", category: "drinks", stock: 40},
                    {id: '11', name: "Orange Juice", price: 5.50, icon: "ðŸ§ƒ", category: "drinks", stock: 35},
                    {id: '12', name: "Bottled Water", price: 2.50, icon: "ðŸ’§", category: "drinks", stock: 90}
                ];
            },
            
            initInventory() {
                // Initialize inventory from menu items
                this.menuItems.forEach(item => {
                    if (!this.inventory[item.id]) {
                        this.inventory[item.id] = {
                            current: item.stock || 50,
                            lowAlert: 10,
                            soldToday: 0
                        };
                    }
                });
            },
            
            async saveMenu() {
                // Save menu items to cloud
                try {
                    for (const item of this.menuItems) {
                        await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/menu`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(item)
                        });
                    }
                } catch (error) {
                    console.error('Error saving menu:', error);
                    // Fallback to localStorage
                    localStorage.setItem('dd_menu', JSON.stringify(this.menuItems));
                }
            },
            
            async saveOrder(order) {
                // Save order to cloud
                try {
                    const response = await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/orders`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(order)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.transactions.push(order);
                        return result;
                    }
                } catch (error) {
                    console.error('Error saving order:', error);
                    // Fallback to localStorage
                    this.transactions.push(order);
                    localStorage.setItem('dd_transactions', JSON.stringify(this.transactions));
                }
            },
            
            updateInventory(itemId, quantitySold) {
                if (this.inventory[itemId]) {
                    this.inventory[itemId].current -= quantitySold;
                    this.inventory[itemId].soldToday += quantitySold;
                    // Update inventory in cloud (async, don't wait)
                    this.updateInventoryInCloud(itemId, this.inventory[itemId].current);
                    return true;
                }
                return false;
            },
            
            async updateInventoryInCloud(itemId, quantity) {
                try {
                    await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/inventory/${itemId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ quantity })
                    });
                } catch (error) {
                    console.error('Error updating inventory:', error);
                }
            },
            
            getLowStockItems() {
                return this.menuItems.filter(item => {
                    const inv = this.inventory[item.id];
                    return inv && inv.current <= inv.lowAlert;
                });
            },
            
            getTodaySales() {
                const today = new Date().toDateString();
                return this.transactions
                    .filter(t => new Date(t.timestamp).toDateString() === today)
                    .reduce((sum, t) => sum + t.total, 0);
            },
            
            getSalesData(period = 'today') {
                const now = new Date();
                const data = { labels: [], values: [] };
                
                switch(period) {
                    case 'today':
                        for(let i = 0; i < 12; i++) {
                            data.labels.push(`${i+6}:00`);
                            data.values.push(Math.floor(Math.random() * 500) + 100);
                        }
                        break;
                    case 'week':
                        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                        data.labels = days;
                        data.values = days.map(() => Math.floor(Math.random() * 3000) + 500);
                        break;
                    case 'month':
                        for(let i = 1; i <= 30; i+=5) {
                            data.labels.push(`Day ${i}`);
                            data.values.push(Math.floor(Math.random() * 8000) + 1000);
                        }
                        break;
                }
                
                return data;
            }
        };

        // ====================
        // AUTHENTICATION
        // ====================
        function initAuth() {
            const loginBtn = document.getElementById('loginBtn');
            const loginModal = document.getElementById('loginModal');
            const posContainer = document.getElementById('posContainer');
            
            loginBtn.addEventListener('click', async () => {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('loginError');
                
                if (!username || !password) {
                    errorDiv.textContent = 'Please enter both username and password';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                try {
                    // For demo purposes, accept any credentials
                    // In production, this would call Cognito
                    localStorage.setItem('id_token', 'demo-token-' + Date.now());
                    localStorage.setItem('user_email', username);
                    
                    loginModal.classList.remove('active');
                    posContainer.style.display = 'grid';
                    
                    // Load data from cloud
                    await POSData.load();
                    POS.init();
                } catch (error) {
                    errorDiv.textContent = 'Login failed: ' + error.message;
                    errorDiv.style.display = 'block';
                }
            });
        }

        // ====================
        // PAYMENT INTEGRATION
        // ====================
        class PaymentProcessor {
            constructor() {
                this.selectedMethod = null;
                this.modal = document.getElementById('paymentModal');
                this.paymentMethods = document.querySelectorAll('.payment-method');
                this.cardDetails = document.getElementById('cardDetails');
                this.confirmBtn = document.getElementById('confirmPayment');
                this.cancelBtn = document.getElementById('cancelPayment');
                this.paymentTotal = document.getElementById('paymentTotal');
                
                this.init();
            }
            
            init() {
                this.paymentMethods.forEach(method => {
                    method.addEventListener('click', () => {
                        this.paymentMethods.forEach(m => m.classList.remove('selected'));
                        method.classList.add('selected');
                        this.selectedMethod = method.dataset.method;
                        this.cardDetails.style.display = 
                            this.selectedMethod === 'card' ? 'block' : 'none';
                    });
                });
                
                this.confirmBtn.addEventListener('click', () => this.processPayment());
                this.cancelBtn.addEventListener('click', () => this.close());
                
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.close();
                });
            }
            
            open(orderTotal) {
                this.paymentTotal.textContent = `RM ${orderTotal.toFixed(2)}`;
                this.modal.style.display = 'flex';
                this.paymentMethods.forEach(m => m.classList.remove('selected'));
                this.selectedMethod = null;
                this.cardDetails.style.display = 'none';
            }
            
            close() {
                this.modal.style.display = 'none';
            }
            
            async processPayment() {
                if (!this.selectedMethod) {
                    alert('Please select a payment method');
                    return;
                }
                
                this.confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                this.confirmBtn.disabled = true;
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const paymentData = {
                    method: this.selectedMethod,
                    amount: parseFloat(this.paymentTotal.textContent.replace('RM ', '')),
                    transactionId: 'TXN' + Date.now().toString().slice(-8),
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                };
                
                this.confirmBtn.innerHTML = '<i class="fas fa-check"></i> Payment Successful!';
                
                setTimeout(() => {
                    this.close();
                    this.confirmBtn.innerHTML = '<i class="fas fa-lock"></i> Confirm Payment';
                    this.confirmBtn.disabled = false;
                    POS.completeOrder(paymentData);
                }, 1000);
            }
        }

        // ====================
        // ADMIN PANEL
        // ====================
        class AdminPanel {
            constructor() {
                this.initMenuManagement();
                this.initUserManagement();
                this.initSystemOverview();
            }
            
            initMenuManagement() {
                // Image preview handler
                const imageInput = document.getElementById('itemImage');
                const imagePreview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file type
                        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                        if (!allowedTypes.includes(file.type)) {
                            alert('Please select a valid image file (JPG, PNG, GIF, or WebP)');
                            e.target.value = '';
                            imagePreview.style.display = 'none';
                            return;
                        }
                        
                        // Validate file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Image file is too large. Please select an image smaller than 5MB.');
                            e.target.value = '';
                            imagePreview.style.display = 'none';
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            imagePreview.style.display = 'block';
                            previewImg.style.display = 'block';
                        };
                        reader.onerror = () => {
                            alert('Error reading image file. Please try again.');
                            e.target.value = '';
                            imagePreview.style.display = 'none';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.style.display = 'none';
                    }
                });
                
                document.getElementById('addMenuItem').addEventListener('click', async () => {
                    const name = document.getElementById('itemName').value;
                    const price = parseFloat(document.getElementById('itemPrice').value);
                    const category = document.getElementById('itemCategory').value;
                    const description = document.getElementById('itemDescription').value;
                    const stock = parseInt(document.getElementById('itemStock').value);
                    const imageFile = document.getElementById('itemImage').files[0];
                    
                    if (!name || !price) {
                        alert('Please fill in required fields');
                        return;
                    }
                    
                    let imageUrl = null;
                    
                    // Upload image if provided
                    if (imageFile) {
                        try {
                            // Show loading message
                            const addButton = document.getElementById('addMenuItem');
                            const originalText = addButton.innerHTML;
                            addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading image...';
                            addButton.disabled = true;
                            
                            // Get presigned URL from API
                            const uploadResponse = await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/images/upload-url`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('id_token') || 'demo'}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    fileName: imageFile.name,
                                    fileType: imageFile.type
                                })
                            });
                            
                            if (uploadResponse.ok) {
                                const { uploadUrl, imageUrl: cdnUrl } = await uploadResponse.json();
                                
                                // Upload file to S3 using presigned URL
                                const uploadResult = await fetch(uploadUrl, {
                                    method: 'PUT',
                                    body: imageFile,
                                    headers: {
                                        'Content-Type': imageFile.type
                                    }
                                });
                                
                                if (uploadResult.ok) {
                                    imageUrl = cdnUrl;
                                    console.log('Image uploaded successfully:', imageUrl);
                                } else {
                                    console.error('Failed to upload image to S3');
                                    // Try local storage as fallback
                                    const localUrl = URL.createObjectURL(imageFile);
                                    imageUrl = localUrl;
                                    console.log('Using local image URL as fallback');
                                }
                            } else {
                                console.error('Failed to get upload URL');
                                // Try local storage as fallback
                                const localUrl = URL.createObjectURL(imageFile);
                                imageUrl = localUrl;
                                console.log('Using local image URL as fallback');
                            }
                            
                            // Restore button
                            addButton.innerHTML = originalText;
                            addButton.disabled = false;
                        } catch (error) {
                            console.error('Error uploading image:', error);
                            // Try local storage as fallback
                            try {
                                const localUrl = URL.createObjectURL(imageFile);
                                imageUrl = localUrl;
                                console.log('Using local image URL as fallback');
                            } catch (fallbackError) {
                                console.error('Failed to create local image URL:', fallbackError);
                            }
                            // Restore button
                            const addButton = document.getElementById('addMenuItem');
                            addButton.innerHTML = '<i class="fas fa-plus"></i> Add Menu Item';
                            addButton.disabled = false;
                        }
                    }
                    
                    const newItem = {
                        id: (POSData.menuItems.length + 1).toString(),
                        name,
                        price,
                        category,
                        stock,
                        icon: this.getIconForCategory(category),
                        description: description || '',
                        imageUrl: imageUrl || null,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    POSData.menuItems.push(newItem);
                    POSData.inventory[newItem.id] = {
                        current: stock,
                        lowAlert: 10,
                        soldToday: 0
                    };
                    
                    // Save to cloud API (including imageUrl)
                    try {
                        const response = await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/menu`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('id_token') || 'demo'}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(newItem)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('Menu item saved to cloud:', result);
                            // Update item with server response (including imageUrl if preserved)
                            if (result.item) {
                                if (result.item.id) newItem.id = result.item.id;
                                if (result.item.imageUrl) newItem.imageUrl = result.item.imageUrl;
                            }
                        } else {
                            console.error('Failed to save to cloud:', response.status, await response.text());
                        }
                    } catch (error) {
                        console.error('Error saving to cloud:', error);
                    }
                    
                    // Also save locally
                    await POSData.saveMenu();
                    POS.initMenu();
                    this.updateSystemOverview();
                    
                    // Clear form
                    document.getElementById('itemName').value = '';
                    document.getElementById('itemPrice').value = '';
                    document.getElementById('itemDescription').value = '';
                    document.getElementById('itemImage').value = '';
                    imagePreview.style.display = 'none';
                    
                    alert('Menu item added successfully!');
                });
            }
            
            getIconForCategory(category) {
                const icons = { donuts: 'ðŸ©', coffee: 'â˜•', drinks: 'ðŸ¥¤' };
                return icons[category] || 'ðŸ“¦';
            }
            
            initUserManagement() {
                document.getElementById('addUser').addEventListener('click', () => {
                    const username = document.getElementById('adminUsername').value;
                    const role = document.getElementById('userRole').value;
                    
                    if (!username) {
                        alert('Please enter a username');
                        return;
                    }
                    
                    POSData.users.push({username, role});
                    localStorage.setItem('dd_users', JSON.stringify(POSData.users));
                    
                    document.getElementById('adminUsername').value = '';
                    alert(`User "${username}" added as ${role}`);
                });
            }
            
            initSystemOverview() {
                document.getElementById('resetData').addEventListener('click', () => {
                    if (confirm('Reset all demo data? This cannot be undone.')) {
                        localStorage.clear();
                        location.reload();
                    }
                });
                
                this.updateSystemOverview();
            }
            
            updateSystemOverview() {
                const todaySales = POSData.getTodaySales();
                document.getElementById('todaySales').textContent = `RM ${todaySales.toFixed(2)}`;
                
                const today = new Date().toDateString();
                const todayTransactions = POSData.transactions
                    .filter(t => new Date(t.timestamp).toDateString() === today).length;
                document.getElementById('todayTransactions').textContent = todayTransactions;
                
                const lowStockCount = POSData.getLowStockItems().length;
                document.getElementById('lowStockCount').textContent = lowStockCount;
            }
        }

        // ====================
        // SALES REPORTS
        // ====================
        class SalesReports {
            constructor() {
                this.salesChart = null;
                this.topItemsChart = null;
                this.initFilters();
                this.initCharts();
                this.updateRecentTransactions();
            }
            
            initFilters() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.filter-btn').forEach(b => 
                            b.classList.remove('active'));
                        btn.classList.add('active');
                        this.updateCharts(btn.dataset.period);
                    });
                });
            }
            
            initCharts() {
                const salesCtx = document.getElementById('salesChart').getContext('2d');
                this.salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [{
                        label: 'Sales (RM)',
                        data: [],
                        borderColor: '#ff8c00',
                        backgroundColor: 'rgba(255, 140, 0, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]},
                    options: { responsive: true, plugins: { legend: {display: false} } }
                });
                
                const itemsCtx = document.getElementById('topItemsChart').getContext('2d');
                this.topItemsChart = new Chart(itemsCtx, {
                    type: 'bar',
                    data: { labels: [], datasets: [{
                        label: 'Units Sold',
                        data: [],
                        backgroundColor: '#3498db'
                    }]},
                    options: { responsive: true, plugins: { legend: {display: false} } }
                });
                
                this.updateCharts('today');
            }
            
            updateCharts(period) {
                const salesData = POSData.getSalesData(period);
                this.salesChart.data.labels = salesData.labels;
                this.salesChart.data.datasets[0].data = salesData.values;
                this.salesChart.update();
                
                const topItems = POSData.menuItems
                    .sort((a, b) => {
                        const soldA = POSData.inventory[a.id]?.soldToday || 0;
                        const soldB = POSData.inventory[b.id]?.soldToday || 0;
                        return soldB - soldA;
                    })
                    .slice(0, 5);
                
                this.topItemsChart.data.labels = topItems.map(item => item.name);
                this.topItemsChart.data.datasets[0].data = 
                    topItems.map(item => POSData.inventory[item.id]?.soldToday || 0);
                this.topItemsChart.update();
            }
            
            updateRecentTransactions() {
                const tbody = document.getElementById('recentTransactions');
                tbody.innerHTML = '';
                
                const recent = POSData.transactions.slice(-10).reverse();
                
                recent.forEach(transaction => {
                    const tr = document.createElement('tr');
                    const date = new Date(transaction.timestamp);
                    const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    tr.innerHTML = `
                        <td>${transaction.id}</td>
                        <td>${timeStr}</td>
                        <td>${transaction.items.length} items</td>
                        <td>${transaction.paymentMethod}</td>
                        <td>RM ${transaction.total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // ====================
        // INVENTORY TRACKING
        // ====================
        class InventoryTracker {
            constructor() {
                this.tableBody = document.getElementById('inventoryTableBody');
                this.lowStockAlerts = document.getElementById('lowStockAlerts');
                this.modal = document.getElementById('addInventoryModal');
                this.standaloneInventory = {}; // For inventory items not linked to menu items
                
                document.getElementById('refreshInventory').addEventListener('click', 
                    () => this.loadInventory());
                document.getElementById('exportInventory').addEventListener('click', 
                    () => this.exportCSV());
                document.getElementById('cancelAddInventory').addEventListener('click', 
                    () => this.closeAddModal());
                document.getElementById('confirmAddInventory').addEventListener('click', 
                    () => this.createInventoryItem());
                
                // Close modal when clicking outside
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.closeAddModal();
                });
                
                // Use event delegation for action buttons (works with dynamically created buttons)
                this.tableBody.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    
                    const action = button.getAttribute('data-action');
                    const itemId = button.getAttribute('data-item-id');
                    
                    if (action === 'increase') {
                        this.adjustStock(itemId, 1);
                    } else if (action === 'decrease') {
                        this.adjustStock(itemId, -1);
                    } else if (action === 'delete') {
                        this.deleteItem(itemId);
                    }
                });
                
                this.loadInventory();
            }
            
            async loadInventory() {
                try {
                    const response = await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/inventory`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        // Store standalone inventory items (items not linked to menu)
                        data.forEach(item => {
                            if (!POSData.menuItems.find(m => m.id === item.id)) {
                                this.standaloneInventory[item.id] = {
                                    id: item.id,
                                    name: item.name,
                                    category: item.category || 'General',
                                    quantity: item.quantity || 0,
                                    lowAlert: item.lowAlert || 10,
                                    current: item.quantity || 0, // Map quantity to current for display
                                    soldToday: item.soldToday || 0
                                };
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading inventory:', error);
                }
                
                this.render();
            }
            
            openAddModal() {
                this.modal.style.display = 'flex';
                // Clear form
                document.getElementById('inventoryItemId').value = '';
                document.getElementById('inventoryItemName').value = '';
                document.getElementById('inventoryItemCategory').value = 'General';
                document.getElementById('inventoryItemQuantity').value = '0';
                document.getElementById('inventoryItemLowAlert').value = '10';
            }
            
            closeAddModal() {
                this.modal.style.display = 'none';
            }
            
            async createInventoryItem() {
                const id = document.getElementById('inventoryItemId').value.trim();
                const name = document.getElementById('inventoryItemName').value.trim();
                const category = document.getElementById('inventoryItemCategory').value.trim() || 'General';
                const quantity = parseInt(document.getElementById('inventoryItemQuantity').value) || 0;
                const lowAlert = parseInt(document.getElementById('inventoryItemLowAlert').value) || 10;
                
                if (!id || !name) {
                    alert('Please fill in Item ID and Item Name');
                    return;
                }
                
                try {
                    const response = await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/inventory`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: id,
                            name: name,
                            category: category,
                            quantity: quantity,
                            lowAlert: lowAlert
                        })
                    });
                    
                    if (response.ok) {
                        const newItem = await response.json();
                        this.standaloneInventory[id] = {
                            id: newItem.id,
                            name: newItem.name,
                            category: newItem.category,
                            quantity: newItem.quantity,
                            lowAlert: newItem.lowAlert,
                            current: newItem.quantity,
                            soldToday: 0
                        };
                        this.closeAddModal();
                        this.render();
                        alert('Inventory item added successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + (error.error || 'Failed to add inventory item'));
                    }
                } catch (error) {
                    console.error('Error creating inventory item:', error);
                    alert('Failed to add inventory item. Please try again.');
                }
            }
            
            async deleteItem(itemId) {
                if (!confirm('Are you sure you want to delete this inventory item?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/inventory/${itemId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        // Remove from standalone inventory if it exists
                        if (this.standaloneInventory[itemId]) {
                            delete this.standaloneInventory[itemId];
                        }
                        // Remove from POSData inventory
                        if (POSData.inventory[itemId]) {
                            delete POSData.inventory[itemId];
                        }
                        this.render();
                        alert('Inventory item deleted successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + (error.error || 'Failed to delete inventory item'));
                    }
                } catch (error) {
                    console.error('Error deleting inventory item:', error);
                    alert('Failed to delete inventory item. Please try again.');
                }
            }
            
            render() {
                this.tableBody.innerHTML = '';
                this.lowStockAlerts.innerHTML = '';
                
                let lowStockCount = 0;
                
                // Render inventory for menu items
                POSData.menuItems.forEach(item => {
                    const inventory = POSData.inventory[item.id];
                    if (!inventory) return;
                    
                    const isLow = inventory.current <= inventory.lowAlert;
                    const statusClass = isLow ? 'stock-low' : 'stock-ok';
                    const statusText = isLow ? 'LOW STOCK' : 'In Stock';
                    
                    if (isLow) lowStockCount++;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${item.name}</strong></td>
                        <td>${item.category}</td>
                        <td class="${statusClass}">${inventory.current}</td>
                        <td>${inventory.lowAlert}</td>
                        <td>${inventory.soldToday}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="qty-btn" data-action="increase" data-item-id="${item.id}">+</button>
                            <button class="qty-btn" data-action="decrease" data-item-id="${item.id}">-</button>
                            <button class="qty-btn" data-action="delete" data-item-id="${item.id}" style="background: #e74c3c; margin-left: 5px;" title="Delete Item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    this.tableBody.appendChild(tr);
                });
                
                // Render standalone inventory items
                Object.values(this.standaloneInventory).forEach(invItem => {
                    const current = invItem.current || invItem.quantity || 0;
                    const lowAlert = invItem.lowAlert || 10;
                    const isLow = current <= lowAlert;
                    const statusClass = isLow ? 'stock-low' : 'stock-ok';
                    const statusText = isLow ? 'LOW STOCK' : 'In Stock';
                    
                    if (isLow) lowStockCount++;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${invItem.name}</strong></td>
                        <td>${invItem.category || 'General'}</td>
                        <td class="${statusClass}">${current}</td>
                        <td>${lowAlert}</td>
                        <td>${invItem.soldToday || 0}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="qty-btn" data-action="increase" data-item-id="${invItem.id}">+</button>
                            <button class="qty-btn" data-action="decrease" data-item-id="${invItem.id}">-</button>
                            <button class="qty-btn" data-action="delete" data-item-id="${invItem.id}" style="background: #e74c3c; margin-left: 5px;" title="Delete Item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    this.tableBody.appendChild(tr);
                });
                
                if (lowStockCount > 0) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'stock-low';
                    alertDiv.style.padding = '15px';
                    alertDiv.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
                    alertDiv.style.borderRadius = '10px';
                    alertDiv.style.marginTop = '10px';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong> ${lowStockCount} item(s) are low on stock!</strong>
                        <p style="margin-top: 5px; margin-bottom: 0;">Please reorder soon.</p>
                    `;
                    this.lowStockAlerts.appendChild(alertDiv);
                } else {
                    this.lowStockAlerts.innerHTML = `
                        <div style="color: #27ae60; padding: 15px;">
                            <i class="fas fa-check-circle"></i>
                            <strong> All items are sufficiently stocked.</strong>
                        </div>
                    `;
                }
            }
            
            adjustStock(itemId, change) {
                // Check if it's a menu item inventory
                if (POSData.inventory[itemId]) {
                    POSData.inventory[itemId].current += change;
                    if (POSData.inventory[itemId].current < 0) {
                        POSData.inventory[itemId].current = 0;
                    }
                    POSData.updateInventoryInCloud(itemId, POSData.inventory[itemId].current);
                    this.render();
                } 
                // Check if it's a standalone inventory item
                else if (this.standaloneInventory[itemId]) {
                    const inv = this.standaloneInventory[itemId];
                    const currentQty = inv.current !== undefined ? inv.current : (inv.quantity || 0);
                    inv.current = currentQty + change;
                    inv.quantity = inv.current; // Keep quantity in sync
                    if (inv.current < 0) {
                        inv.current = 0;
                        inv.quantity = 0;
                    }
                    // Update in cloud
                    this.updateInventoryInCloud(itemId, inv.current);
                    this.render();
                }
            }
            
            async updateInventoryInCloud(itemId, quantity) {
                try {
                    await fetch(`${CLOUD_CONFIG.API_ENDPOINT}/inventory/${itemId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('id_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ quantity })
                    });
                } catch (error) {
                    console.error('Error updating inventory:', error);
                }
            }
            
            exportCSV() {
                let csv = 'Item Name,Category,Current Stock,Low Stock Alert,Sold Today\n';
                
                // Export menu item inventory
                POSData.menuItems.forEach(item => {
                    const inv = POSData.inventory[item.id];
                    if (inv) {
                        csv += `"${item.name}","${item.category}",${inv.current},${inv.lowAlert},${inv.soldToday}\n`;
                    }
                });
                
                // Export standalone inventory items
                Object.values(this.standaloneInventory).forEach(invItem => {
                    const current = invItem.current !== undefined ? invItem.current : (invItem.quantity || 0);
                    csv += `"${invItem.name}","${invItem.category || 'General'}",${current},${invItem.lowAlert || 10},${invItem.soldToday || 0}\n`;
                });
                
                const blob = new Blob([csv], {type: 'text/csv'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory-${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                
                alert('Inventory data exported as CSV');
            }
        }

        // ====================
        // ADMIN AUTHENTICATION
        // ====================
        const AdminAuth = {
            // Default admin credentials (in production, use secure authentication)
            adminCredentials: {
                'admin': 'admin123',
                'manager': 'manager123'
            },
            
            isAuthenticated() {
                const adminSession = localStorage.getItem('adminSession');
                if (!adminSession) return false;
                
                try {
                    const session = JSON.parse(adminSession);
                    // Check if session is still valid (24 hours)
                    const now = Date.now();
                    if (now - session.timestamp > 24 * 60 * 60 * 1000) {
                        this.logout();
                        return false;
                    }
                    return true;
                } catch (e) {
                    return false;
                }
            },
            
            getCurrentAdmin() {
                const adminSession = localStorage.getItem('adminSession');
                if (!adminSession) return null;
                
                try {
                    const session = JSON.parse(adminSession);
                    return session.username;
                } catch (e) {
                    return null;
                }
            },
            
            login(username, password) {
                // Check credentials
                if (this.adminCredentials[username] === password) {
                    const session = {
                        username: username,
                        timestamp: Date.now(),
                        role: 'admin'
                    };
                    localStorage.setItem('adminSession', JSON.stringify(session));
                    return true;
                }
                return false;
            },
            
            logout() {
                localStorage.removeItem('adminSession');
                this.hideAdminPanel();
            },
            
            showAdminPanel() {
                const adminTab = document.getElementById('admin-tab');
                const adminProfileInfo = document.getElementById('adminProfileInfo');
                const adminDisplayName = document.getElementById('adminDisplayName');
                const adminLogoutBtn = document.getElementById('adminLogoutBtn');
                
                if (adminTab) {
                    adminTab.style.display = 'block';
                }
                
                const currentAdmin = this.getCurrentAdmin();
                if (currentAdmin) {
                    if (adminProfileInfo) adminProfileInfo.style.display = 'block';
                    if (adminDisplayName) adminDisplayName.textContent = currentAdmin;
                    if (adminLogoutBtn) adminLogoutBtn.style.display = 'block';
                }
            },
            
            hideAdminPanel() {
                const adminTab = document.getElementById('admin-tab');
                const adminProfileInfo = document.getElementById('adminProfileInfo');
                const adminLogoutBtn = document.getElementById('adminLogoutBtn');
                
                if (adminTab) {
                    adminTab.style.display = 'none';
                }
                if (adminProfileInfo) adminProfileInfo.style.display = 'none';
                if (adminLogoutBtn) adminLogoutBtn.style.display = 'none';
            },
            
            init() {
                // Check if already authenticated
                if (this.isAuthenticated()) {
                    this.showAdminPanel();
                } else {
                    this.hideAdminPanel();
                }
                
                // Admin login modal handlers
                const adminLoginModal = document.getElementById('adminLoginModal');
                const confirmAdminLogin = document.getElementById('confirmAdminLogin');
                const cancelAdminLogin = document.getElementById('cancelAdminLogin');
                const adminLoginError = document.getElementById('adminLoginError');
                
                const performLogin = () => {
                    const username = document.getElementById('adminLoginUsername').value.trim();
                    const password = document.getElementById('adminLoginPassword').value;
                    
                    if (!username || !password) {
                        if (adminLoginError) {
                            adminLoginError.textContent = 'Please enter both username and password';
                            adminLoginError.style.display = 'block';
                        }
                        return;
                    }
                    
                    if (this.login(username, password)) {
                        // Success
                        if (adminLoginModal) adminLoginModal.style.display = 'none';
                        if (adminLoginError) adminLoginError.style.display = 'none';
                        document.getElementById('adminLoginUsername').value = '';
                        document.getElementById('adminLoginPassword').value = '';
                        this.showAdminPanel();
                        // Switch to admin tab
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.querySelector('.nav-tab[data-tab="admin-tab"]').classList.add('active');
                        document.getElementById('admin-tab').classList.add('active');
                        alert('Login successful! Welcome, ' + username);
                    } else {
                        // Failed
                        if (adminLoginError) {
                            adminLoginError.textContent = 'Invalid username or password';
                            adminLoginError.style.display = 'block';
                        }
                    }
                };
                
                if (confirmAdminLogin) {
                    confirmAdminLogin.addEventListener('click', performLogin);
                }
                
                // Enter key support
                const adminLoginPassword = document.getElementById('adminLoginPassword');
                if (adminLoginPassword) {
                    adminLoginPassword.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            performLogin();
                        }
                    });
                }
                
                const adminLoginUsername = document.getElementById('adminLoginUsername');
                if (adminLoginUsername) {
                    adminLoginUsername.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('adminLoginPassword').focus();
                        }
                    });
                }
                
                if (cancelAdminLogin) {
                    cancelAdminLogin.addEventListener('click', () => {
                        if (adminLoginModal) adminLoginModal.style.display = 'none';
                        if (adminLoginError) adminLoginError.style.display = 'none';
                        document.getElementById('adminLoginUsername').value = '';
                        document.getElementById('adminLoginPassword').value = '';
                        // Switch back to POS tab
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.querySelector('.nav-tab[data-tab="pos-tab"]').classList.add('active');
                        document.getElementById('pos-tab').classList.add('active');
                    });
                }
                
                // Logout handler
                const adminLogoutBtn = document.getElementById('adminLogoutBtn');
                if (adminLogoutBtn) {
                    adminLogoutBtn.addEventListener('click', () => {
                        if (confirm('Are you sure you want to logout?')) {
                            this.logout();
                            alert('Logged out successfully');
                            // Switch to POS tab
                            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                            document.querySelector('.nav-tab[data-tab="pos-tab"]').classList.add('active');
                            document.getElementById('pos-tab').classList.add('active');
                        }
                    });
                }
                
                // Close modal when clicking outside
                if (adminLoginModal) {
                    adminLoginModal.addEventListener('click', (e) => {
                        if (e.target === adminLoginModal) {
                            adminLoginModal.style.display = 'none';
                        }
                    });
                }
            }
        };

        // ====================
        // MAIN POS APPLICATION
        // ====================
        const POS = {
            currentOrder: [],
            orderNumber: 1,
            paymentProcessor: null,
            adminPanel: null,
            salesReports: null,
            inventoryTracker: null,
            
            init() {
                this.paymentProcessor = new PaymentProcessor();
                this.adminPanel = new AdminPanel();
                this.salesReports = new SalesReports();
                this.inventoryTracker = new InventoryTracker();
                AdminAuth.init();
                
                this.initNavigation();
                this.initMenu();
                this.initOrderListeners();
                this.updateOrderDisplay();
            },
            
            initNavigation() {
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Check if trying to access admin tab
                        if (tab.dataset.tab === 'admin-tab') {
                            if (!AdminAuth.isAuthenticated()) {
                                // Show login modal
                                const adminLoginModal = document.getElementById('adminLoginModal');
                                if (adminLoginModal) {
                                    adminLoginModal.style.display = 'flex';
                                    document.getElementById('adminLoginUsername').focus();
                                }
                                // Don't switch tabs
                                return;
                            }
                        }
                        
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        document.querySelectorAll('.nav-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        tab.classList.add('active');
                        document.getElementById(tab.dataset.tab).classList.add('active');
                        
                        if (tab.dataset.tab === 'reports-tab') {
                            this.salesReports.updateCharts('today');
                            this.salesReports.updateRecentTransactions();
                        } else if (tab.dataset.tab === 'inventory-tab') {
                            this.inventoryTracker.render();
                        } else if (tab.dataset.tab === 'admin-tab') {
                            this.adminPanel.updateSystemOverview();
                        }
                    });
                });
            },
            
            initMenu() {
                const menuGrid = document.getElementById('menuGrid');
                menuGrid.innerHTML = '';
                
                POSData.menuItems.forEach(item => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'menu-item';
                    menuItem.dataset.category = item.category;
                    
                    // Use image if available, otherwise use icon
                    let imageHtml = '';
                    if (item.imageUrl) {
                        // Create a unique key for the image to force refresh if needed
                        const imageKey = item.imageUrl.includes('blob:') ? item.imageUrl : `${item.imageUrl}?t=${Date.now()}`;
                        imageHtml = `<img src="${imageKey}" alt="${item.name}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; background: #f0f0f0;" 
                           onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                           onload="this.style.display='block'; if(this.nextElementSibling) this.nextElementSibling.style.display='none';">
                           <div class="item-icon" style="display: none; font-size: 32px; margin-bottom: 12px; color: #d22c26; justify-content: center; align-items: center; height: 120px;">${item.icon || 'ðŸ©'}</div>`;
                    } else {
                        imageHtml = `<div class="item-icon">${item.icon || 'ðŸ©'}</div>`;
                    }
                    
                    menuItem.innerHTML = `
                        ${imageHtml}
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">RM ${item.price.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Stock: ${POSData.inventory[item.id]?.current || 0}
                        </div>
                    `;
                    
                    menuItem.addEventListener('click', () => {
                        const inventory = POSData.inventory[item.id];
                        if (inventory && inventory.current <= 0) {
                            alert(`Sorry, ${item.name} is out of stock!`);
                            return;
                        }
                        this.addToOrder(item);
                    });
                    
                    menuGrid.appendChild(menuItem);
                });
                
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.category-tab').forEach(t => 
                            t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const category = tab.dataset.category;
                        document.querySelectorAll('.menu-item').forEach(item => {
                            item.style.display = 
                                (category === 'all' || item.dataset.category === category) 
                                ? 'flex' : 'none';
                        });
                    });
                });
            },
            
            initOrderListeners() {
                document.getElementById('clearOrder').addEventListener('click', () => this.clearOrder());
                document.getElementById('checkoutBtn').addEventListener('click', () => this.initiateCheckout());
                document.getElementById('closeReceipt').addEventListener('click', () => this.closeReceipt());
                
                document.getElementById('receiptModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('receiptModal')) {
                        this.closeReceipt();
                    }
                });
            },
            
            addToOrder(item) {
                const existingItem = this.currentOrder.find(orderItem => orderItem.id === item.id);
                
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    this.currentOrder.push({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        icon: item.icon,
                        quantity: 1
                    });
                }
                
                this.updateOrderDisplay();
                document.getElementById('emptyCart').style.display = 'none';
            },
            
            updateOrderDisplay() {
                const orderItems = document.getElementById('orderItems');
                orderItems.innerHTML = '';
                
                if (this.currentOrder.length === 0) {
                    document.getElementById('emptyCart').style.display = 'block';
                    this.updateTotals();
                    return;
                }
                
                this.currentOrder.forEach((item, index) => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                        <div>
                            <div style="font-weight: 700; margin-bottom: 5px;">${item.name}</div>
                            <div style="color: #ff8c00; font-weight: 700;">RM ${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                        <div class="item-controls">
                            <button class="qty-btn decrease-btn" data-index="${index}">-</button>
                            <span class="item-qty">${item.quantity}</span>
                            <button class="qty-btn increase-btn" data-index="${index}">+</button>
                            <button class="remove-item" data-index="${index}">Remove</button>
                        </div>
                    `;
                    
                    orderItems.appendChild(orderItem);
                });
                
                document.querySelectorAll('.decrease-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.decreaseQuantity(index);
                    });
                });
                
                document.querySelectorAll('.increase-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.increaseQuantity(index);
                    });
                });
                
                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.removeItem(index);
                    });
                });
                
                this.updateTotals();
            },
            
            decreaseQuantity(index) {
                if (this.currentOrder[index].quantity > 1) {
                    this.currentOrder[index].quantity--;
                } else {
                    this.currentOrder.splice(index, 1);
                }
                this.updateOrderDisplay();
            },
            
            increaseQuantity(index) {
                this.currentOrder[index].quantity++;
                this.updateOrderDisplay();
            },
            
            removeItem(index) {
                this.currentOrder.splice(index, 1);
                this.updateOrderDisplay();
            },
            
            updateTotals() {
                const subtotal = this.calculateSubtotal();
                const tax = this.calculateTax();
                const total = this.calculateTotal();
                
                document.getElementById('subtotal').textContent = `RM ${subtotal.toFixed(2)}`;
                document.getElementById('tax').textContent = `RM ${tax.toFixed(2)}`;
                document.getElementById('total').textContent = `RM ${total.toFixed(2)}`;
            },
            
            calculateSubtotal() {
                return this.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            },
            
            calculateTax() {
                return this.calculateSubtotal() * 0.06;
            },
            
            calculateTotal() {
                return this.calculateSubtotal() + this.calculateTax();
            },
            
            clearOrder() {
                this.currentOrder = [];
                this.updateOrderDisplay();
                document.getElementById('emptyCart').style.display = 'block';
            },
            
            initiateCheckout() {
                if (this.currentOrder.length === 0) {
                    alert("Your order is empty. Add items before checkout.");
                    return;
                }
                this.paymentProcessor.open(this.calculateTotal());
            },
            
            async completeOrder(paymentData) {
                const transaction = {
                    id: `DD-${this.orderNumber.toString().padStart(3, '0')}`,
                    timestamp: new Date().toISOString(),
                    items: [...this.currentOrder],
                    subtotal: this.calculateSubtotal(),
                    tax: this.calculateTax(),
                    total: this.calculateTotal(),
                    paymentMethod: paymentData.method,
                    paymentId: paymentData.transactionId
                };
                
                this.currentOrder.forEach(item => {
                    POSData.updateInventory(item.id, item.quantity);
                });
                
                await POSData.saveOrder(transaction);
                
                this.generateReceipt(transaction);
                
                this.currentOrder = [];
                this.updateOrderDisplay();
                document.getElementById('emptyCart').style.display = 'block';
                
                this.orderNumber++;
                this.adminPanel.updateSystemOverview();
                this.salesReports.updateRecentTransactions();
                this.inventoryTracker.render();
            },
            
            generateReceipt(transaction) {
                document.getElementById('receiptNumber').textContent = transaction.id;
                const now = new Date(transaction.timestamp);
                document.getElementById('receiptDate').textContent = now.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const receiptItems = document.getElementById('receiptItems');
                receiptItems.innerHTML = '';
                transaction.items.forEach(item => {
                    const receiptItem = document.createElement('div');
                    receiptItem.className = 'receipt-item';
                    receiptItem.innerHTML = `
                        <div>
                            <div>${item.name} x ${item.quantity}</div>
                        </div>
                        <div>RM ${(item.price * item.quantity).toFixed(2)}</div>
                    `;
                    receiptItems.appendChild(receiptItem);
                });
                
                document.getElementById('receiptSubtotal').textContent = `RM ${transaction.subtotal.toFixed(2)}`;
                document.getElementById('receiptTax').textContent = `RM ${transaction.tax.toFixed(2)}`;
                document.getElementById('receiptTotal').textContent = `RM ${transaction.total.toFixed(2)}`;
                
                document.getElementById('receiptModal').style.display = 'flex';
            },
            
            closeReceipt() {
                document.getElementById('receiptModal').style.display = 'none';
            }
        };

        // Initialize authentication and app
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
        });

        // Make Inventory tracker globally accessible (for backward compatibility)
        window.Inventory = null;
        
        // Initialize Inventory after POS is initialized
        setTimeout(() => {
            if (POS.inventoryTracker) {
                window.Inventory = POS.inventoryTracker;
            }
        }, 1000);
    </script>
</body>
</html>
